# Web Agent - Special Controls Plugin

## Overview

The Special Controls Plugin is a component designed to run within the `@web-agent/frontend` environment. Its primary purpose is to analyze the Document Object Model (DOM) of a web page in conjunction with a user's instruction to identify "special" or complex UI controls. For these controls, it suggests a sequence of interaction steps, aiming to improve the reliability and accuracy of AI-generated action plans.

Examples of special controls include date pickers, sliders, custom dropdown menus, file upload widgets, etc., which often require multi-step interactions beyond simple clicks or text inputs.

## Key Function

The main exported function from this plugin is:

```typescript
identifySpecialControls(domRoot: DomNode, userInstruction: string): SpecialControlRecommendation[]
```

*   **`domRoot: DomNode`**: The root of the DOM tree (using the canonical `DomNode` type from `@web-agent/shared-types`) for the current page.
*   **`userInstruction: string`**: The natural language instruction provided by the user (e.g., "Select March 15, 2024 as the event date").
*   **Returns**: An array of `SpecialControlRecommendation` objects. Each object contains information about a detected special control and the recommended steps to interact with it based on the instruction.

## Rule Definition

The plugin works based on a set of predefined rules. Each rule is responsible for:
1.  **Identifying** a specific type of special control within the `domRoot` (e.g., by looking for specific HTML attributes like `data-testid`, `aria-label`, `placeholder`, or tag names and types).
2.  **Correlating** the identified control with relevant parts of the `userInstruction` (e.g., extracting "March 15, 2024" when a date picker is found).
3.  **Generating** a list of `RecommendedActionStep`s that detail how to interact with the control to fulfill the inferred user intent (e.g., steps to click open a calendar, then input or select the specific date).

**Example Rule (Date Picker):**
The current implementation includes a rule to detect date pickers. It looks for input elements with attributes like `data-testid="date-picker-input"`, `aria-label` containing "date picker", or `placeholder` text related to dates. If such an element is found, it attempts to parse a date from the `userInstruction` using regular expressions. If a date is found, it recommends steps like clicking the input and then directly inputting the normalized date.

## Output Structure

The plugin outputs an array of `SpecialControlRecommendation` objects. Each recommendation includes:

*   `detectedElementId: string`: The ID of the primary HTML element associated with the detected special control.
*   `originalInstructionFragment?: string`: The part of the user's instruction that seems relevant to this control (e.g., the specific date string).
*   `confidence?: number`: A score (0.0 to 1.0) indicating the plugin's confidence in this particular recommendation.
*   `recommendedSteps: RecommendedActionStep[]`: An array of action steps. Each step has:
    *   `type: ActionType` (e.g., CLICK, INPUT).
    *   `targetElementId?: string` (ID of the element for the action).
    *   `value?: string` (e.g., text to input).
    *   `description: string` (human-readable description of the step).
    *   `parameters?: Record<string, any>`.

## Integration

*   **Frontend Usage**: The `@web-agent/frontend` package calls `identifySpecialControls` after capturing the DOM.
*   **Backend Influence**: The `SpecialControlRecommendation[]` generated by this plugin are sent by the frontend to the `@web-agent/backend`. The backend then formats these recommendations into textual hints and includes them in the `actionContext` provided to the `@midscene/core` AI planner. This helps the AI generate more precise and effective action plans for pages with these special controls.
